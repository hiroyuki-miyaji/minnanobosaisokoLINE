<script>
const LIFF_ID = "2008561144-5WLWMVPP";

function debug(msg) {
    console.log(msg);
    const area = document.getElementById("debugArea");
    area.innerHTML += msg + "<br>";
}

async function main() {
    debug("=== index.html start ===");

    // グローバルエラー
    window.addEventListener("error", e => {
        debug("[JS ERROR] " + e.message);
    });

    // ★★ここだけ修正★★
    let ok = false;
    try {
        ok = await initLiff(LIFF_ID);
        if (!ok) return;  // login に飛ぶ場合もある
    } catch (e) {
        debug("LIFF init FAILED: " + e);
        document.getElementById("status").innerText = "LIFF初期化に失敗しました";
        return;
    }

    debug("LIFF init OK");

    // ★以下はそのままでOK（元のコードを変えない）
    let profile;
    try {
        profile = await liff.getProfile();
        debug("profile OK: " + profile.userId);

        document.getElementById("status").innerText =
            profile.displayName + " さんでログイン中";
    } catch (e) {
        debug("profile FAILED: " + e);
        document.getElementById("status").innerText = "プロフィール取得失敗";
        return;
    }

    // 管理者チェック（元のコード）
    const admin = await getAdmin(profile.userId);
    debug("getAdmin result: " + JSON.stringify(admin));

    const menu = document.getElementById("menuArea");

    const isRegistered =
        admin && admin.items && Array.isArray(admin.items) && admin.items.length > 0;

    if (!isRegistered) {
        menu.style.display = "none";
        document.getElementById("status").innerText = "管理者登録が必要です";
        menu.innerHTML = `<a class="btn" href="./register_admin.html">管理者情報を登録する</a>`;
        menu.style.display = "block";
        menu.style.opacity = "1.0";
        menu.style.pointerEvents = "auto";
        return;
    }

    menu.style.opacity = "1.0";
    menu.style.pointerEvents = "auto";

    document.getElementById("status").innerText =
        profile.displayName + " さん（管理者）";

    debug("=== index.html end ===");
}

main();
</script>
