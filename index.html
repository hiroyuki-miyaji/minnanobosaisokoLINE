<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>みんなの防災倉庫 管理アプリ</title>

    <!-- キャッシュ無効化 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- ui用のjs -->
    <link rel="stylesheet" href="./css/ui.css?v=1">

    <!-- LIFF SDK（正しいパス） -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- 共通ロジック -->
    <script type="module" src="./js/liff.js?v=2001"></script>

    <!-- API -->
    <script src="./js/api.js?v=2001"></script>

    <link rel="stylesheet" href="./css/style.css?v=2001">
</head>

<body>

<h2>みんなの防災倉庫 管理アプリ</h2>
<div id="status">LIFF アプリ初期化中...<br>メニューが表示されない場合閉じてもう一度起動してください。</div>

<!-- メニュー -->
<div id="menuArea"></div>

<!-- デバッグログ -->
<div id="debugArea" class="debug"></div>

<script type="module">
import { renderHeader, renderFooter } from "./js/ui.js?v=1";
renderHeader("みんなの防災倉庫管理");
renderFooter();

import { initLiff, getUserProfile, debug } from "./js/liff.js?v=2001";

async function main() {
    debug("=== index start ===");

    // ----------------------------------------
    // LIFF 初期化
    // ----------------------------------------
    const ok = await initLiff();
    if (!ok) {
        document.getElementById("status").innerHTML =
            "<p class='error'>LIFF 初期化に失敗しました</p>";
        return;
    }

    // ----------------------------------------
    // プロフィール取得
    // ----------------------------------------
    let profile;
    try {
        profile = await getUserProfile();
    } catch (e) {
        document.getElementById("status").innerHTML =
            "<p class='error'>プロフィール取得に失敗しました</p>";
        return;
    }

    const lineId = profile.userId;
    debug("LINE Profile OK");

    // ----------------------------------------
    // 管理者情報取得
    // ----------------------------------------
    const admin = await getAdmin(lineId);
    debug("getAdmin response:OK");

    const status = document.getElementById("status");
    const menu   = document.getElementById("menuArea");

    const items = admin?.items ?? [];
    const isRegistered = items.length > 0;

    // ----------------------------------------
    // 未登録
    // ----------------------------------------
    if (!isRegistered) {
        status.innerHTML = `
            <div class="status-name">${profile.displayName} さん</div>
            <div class="status-sub">利用には管理者登録が必要です</div>
        `;

        menu.innerHTML = `
            <a class="btn btn-green" href="./register_admin.html">
                管理者情報を登録する
            </a>
        `;
        return;
    }

    // ----------------------------------------
    // 登録済み
    // ----------------------------------------
    const adminInfo = items[0];

    status.innerHTML = `
        <div class="status-sub">${adminInfo.organization ?? ""}</div>
        <div class="status-name">${adminInfo.name} さん</div>
    `;

    menu.innerHTML = `
        <a class="btn btn-blue" href="./list.html">登録済倉庫一覧</a>
        <a class="btn btn-blue" href="./register_warehouse.html">防災倉庫を追加登録</a>
        <a class="btn btn-blue" href="./register_admin.html">管理者情報を変更</a>
    `;

    debug("=== index end ===");
}

main();
</script>

</body>
</html>
