<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>みんなの防災倉庫 管理アプリ</title>

    <!-- キャッシュ無効化 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- LIFF SDK（正しいパス） -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- API -->
    <script src="./js/api.js?v=2001"></script>

    <link rel="stylesheet" href="./css/style.css?v=2001">
</head>

<body>

<h2>みんなの防災倉庫 管理アプリ</h2>
<div id="status">LIFF 初期化中...</div>

<!-- メニュー -->
<div id="menuArea"></div>

<!-- デバッグログ -->
<div id="debugArea" class="debug"></div>

<script>
function debug(msg){
    console.log(msg);
    document.getElementById("debugArea").innerHTML += msg + "<br>";
}

async function initLiff() {
    try {
        await liff.init({ liffId: "2008561144-5WLWMVPP" });

        if (!liff.isLoggedIn()) {
            liff.login();
            return false;
        }
        return true;
    } catch (e) {
        debug("LIFF init error: " + e);
        return false;
    }
}

async function main() {
    debug("=== index start ===");

    const ok = await initLiff();
    if (!ok) return;

    let profile = await liff.getProfile();
    const lineId = profile.userId;

    debug("LINE Profile OK: " + profile.displayName);

    // ------- getAdmin 実行 -------
    const admin = await getAdmin(lineId);
    debug("getAdmin response: " + JSON.stringify(admin));

    const status = document.getElementById("status");
    const menu = document.getElementById("menuArea");

    const items = admin?.items ?? [];
    const isRegistered = items.length > 0;

    // ====== 未登録 ======
    if (!isRegistered) {
        status.innerHTML = `
            <div class="status-name">${profile.displayName} さん</div>
            <div class="status-sub">利用には管理者登録が必要です</div>
        `;

        menu.innerHTML = `
            <a class="btn btn-green" href="./register_admin.html">
                管理者情報を登録する
            </a>
        `;
        return;
    }

    // ====== 登録済み ======
    const adminInfo = items[0];

    status.innerHTML = `
        <div class="status-name">${adminInfo.name} さん（管理者）</div>
        <div class="status-sub">${adminInfo.organization ?? ""}</div>
    `;

    menu.innerHTML = `
        <a class="btn btn-blue" href="./list.html">登録済倉庫一覧</a>
        <a class="btn btn-blue" href="./register_warehouse.html">防災倉庫を追加登録</a>
        <a class="btn btn-blue" href="./register_admin.html">管理者情報を変更</a>
    `;
}

main();
</script>

</body>
</html>
