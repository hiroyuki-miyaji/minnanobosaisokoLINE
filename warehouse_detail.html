<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜²ç½å€‰åº« è©³ç´°</title>

    <!-- uiç”¨ã®js -->
    <link rel="stylesheet" href="./css/ui.css?v=1">

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- å…±é€šãƒ­ã‚¸ãƒƒã‚¯ -->
    <script type="module" src="./js/liff.js?v=2001"></script>

    <!-- API -->
    <script src="./js/api.js?v=2001"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="./css/style.css?v=2001">
</head>

<body>

<h2>é˜²ç½å€‰åº« è©³ç´°</h2>

<div id="status">èª­ã¿è¾¼ã¿ä¸­...</div>

<div id="detailArea" class="form-container"></div>

<div id="debugArea" class="debug"></div>

<script type="module">
import { renderHeader, renderFooter } from "./js/ui.js?v=1";

renderHeader("ã¿ã‚“ãªã®é˜²ç½å€‰åº«ç®¡ç†");
renderFooter();

import { initLiff, getUserProfile, debug } from "./js/liff.js?v=2001";

let lineId = null;
let number = null;

/* ----------------------------------------
   åˆæœŸåŒ–
----------------------------------------- */
async function main() {
    debug("=== warehouse_detail start ===");

    const ok = await initLiff();
    if (!ok) {
        document.getElementById("status").innerHTML =
            "<p class='error'>LIFF åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ</p>";
        return;
    }

    // LINEãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
    const profile = await getUserProfile();
    lineId = profile.userId;

    // URLã‹ã‚‰ã€ŒãƒŠãƒ³ãƒãƒ¼ã€ã‚’å–å¾—
    const params = new URLSearchParams(location.search);
    number = params.get("id");  // â† ãƒŠãƒ³ãƒãƒ¼ã‚’å—ã‘å–ã‚‹
    debug("number: " + number);

    if (!number) {
        document.getElementById("status").innerHTML =
            "<p class='error'>å€‰åº«ç•ªå·ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>";
        return;
    }

    loadDetail();
}

/* ----------------------------------------
   å€‰åº«è©³ç´°ã®ãƒ­ãƒ¼ãƒ‰
----------------------------------------- */
async function loadDetail() {

    debug("call getWarehouseDetail()");
    const res = await getWarehouseDetail({ LINEID: lineId, number });

    debug("response:OK");

    if (res.result !== "success") {
        document.getElementById("status").innerHTML =
            "<p class='error'>å€‰åº«æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
        return;
    }

    // â† items[0] ã‚’å–å¾—
    const w = res.items?.[0];

    if (!w) {
        document.getElementById("status").innerHTML =
            "<p class='error'>è©²å½“ã™ã‚‹å€‰åº«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
        return;
    }

    document.getElementById("status").innerHTML = "";

    const area = document.getElementById("detailArea");
    area.innerHTML = `
        <div class="warehouse-card">

            <div class="warehouse-title">${w.number} <img src='${w.imageURL}' width="40%"></image></div>
            <div class="warehouse-field"><strong>é˜²ç½å€‰åº«åï¼š</strong>${w.name}</div>
            <div class="warehouse-field"><strong>è¨­ç½®å ´æ‰€ä½æ‰€ï¼š</strong>${w.address}</div>
            <div class="warehouse-field"><strong>ã‚µãƒãƒ¼ã‚¿ãƒ¼ä¼æ¥­ï¼š</strong>${w.supporter}</div>
            <div class="warehouse-field"><strong>è¨­ç½®æ—¥ï¼š</strong>${w.settlementDate}</div>
            <div class="warehouse-field"><strong>å‚™è“„å“ï¼š</strong>${w.stocks}</div>
            <div class="warehouse-field"><strong>æš—è¨¼ç•ªå·ï¼š</strong>${w.password}</div>
            <div class="warehouse-field"><strong>å…¬é–‹ï¼š</strong>${w.publish}</div>
            <div class="warehouse-field"><strong>é€šçŸ¥ï¼š</strong>${w.notify}</div>
            <div class="warehouse-field"><strong>ç™»éŒ²è€…æ•°ï¼š</strong>${w.registerNumber}</div>
            
            <!-- ç·¨é›†ç”»é¢ã¸é·ç§»ã™ã‚‹ãƒœã‚¿ãƒ³ï¼ˆåŸºæœ¬æƒ…å ±ã®ç›´ä¸‹ï¼‰ -->
            <a href="./edit_warehouse.html?id=${w.number}"
               class="btn btn-edit"
               style="margin-top:14px; margin-bottom:18px;">
                âœï¸ ç·¨é›†ã™ã‚‹
            </a>
            
            <div style="margin-top: 18px;"></div>

            <button class="btn btn-red" id="btnUnlockNotify">
                ğŸ””ğŸ”“ é€šçŸ¥ã—ã¦è§£éŒ 
            </button>

            <button class="btn btn-red" id="btnUnlockSilent">
                ğŸ”“ é€šçŸ¥ãªã—ã§è§£éŒ 
            </button>

            <button class="btn btn-blue" id="btnLock">
                ğŸ”’ æ–½éŒ ã™ã‚‹
            </button>

        </div>
    `;

    // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById("btnUnlockNotify").addEventListener("click", () => {
        operate("unlock_notify");
    });

    document.getElementById("btnUnlockSilent").addEventListener("click", () => {
        operate("unlock_silent");
    });

    document.getElementById("btnLock").addEventListener("click", () => {
        operate("lock");
    });
}


/* ----------------------------------------
   æ“ä½œï¼ˆè§£éŒ  / æ–½éŒ ï¼‰
----------------------------------------- */
async function operate(mode) {

    let msg =
        mode === "unlock_notify" ? "é€šçŸ¥ã—ã¦è§£éŒ ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ" :
        mode === "unlock_silent" ? "é€šçŸ¥ãªã—ã§è§£éŒ ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ" :
        "å€‰åº«ã‚’æ–½éŒ ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ";

    if (!confirm(msg)) return;

    const res = await operateWarehouse({
        LINEID: lineId,
        number,
        mode
    });

    if (res.result === "success") {
        alert("æ“ä½œãŒå®Œäº†ã—ã¾ã—ãŸï¼");
        location.href = "./list.html";
    } else {
        alert("æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
}

main();
</script>

</body>
</html>
