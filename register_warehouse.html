<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>防災倉庫の追加登録</title>

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- 共通ロジック -->
    <script type="module" src="./js/liff.js?v=2001"></script>

    <!-- API 共通 -->
    <script src="./js/api.js?v=2001"></script>

    <link rel="stylesheet" href="./css/style.css?v=2001">
</head>

<body>

<h2>防災倉庫の追加登録</h2>

<div id="status">登録者情報を確認中...</div>

<div class="form-container">

    <label>防災倉庫ナンバー</label>
    <input id="number" class="form-input" type="text" placeholder="例：hs0001">

    <label>倉庫名</label>
    <input id="name" class="form-input" type="text" placeholder="例：神田袋町パーキング">

    <label>住所</label>
    <input id="address" class="form-input" type="text" placeholder="例：広島県広島市...">

    <label>サポーター企業（任意）</label>
    <input id="supporter" class="form-input" type="text" placeholder="例：株式会社〇〇">

    <button id="btnSubmit" class="btn btn-green">登録する</button>
</div>

<div id="msgArea"></div>
<div id="debugArea" class="debug"></div>

<script type="module">
import { initLiff, getUserProfile, debug } from "./js/liff.js?v=2001";

let lineId = null;

/* ----------------------------------------
   初期化処理
----------------------------------------- */
async function main() {
    debug("=== register_warehouse.html start ===");

    const ok = await initLiff();
    if (!ok) return;

    const profile = await getUserProfile();
    lineId = profile.userId;

    // 管理者登録確認
    const admin = await getAdmin(lineId);
    debug("getAdmin: " + JSON.stringify(admin));

    if (!admin.items || admin.items.length === 0) {
        document.getElementById("status").innerHTML =
            "<p class='error'>管理者登録が必要です</p>";
        document.querySelector(".form-container").style.display = "none";
        return;
    }

    document.getElementById("status").innerHTML =
        `<div class="status-name">${admin.items[0].name} さん</div>
         <div class="status-sub">防災倉庫を登録できます</div>`;
}

main();

/* ----------------------------------------
   登録処理
----------------------------------------- */
document.getElementById("btnSubmit").addEventListener("click", async () => {

    const payload = {
        action: "registerWarehouse",
        LINEID: lineId,
        number: document.getElementById("number").value,
        name: document.getElementById("name").value,
        address: document.getElementById("address").value,
        supporter: document.getElementById("supporter").value
    };

    debug("send payload: " + JSON.stringify(payload));

    const res = await registerWarehouse(payload);
    debug("response: " + JSON.stringify(res));

    if (res.result === "success") {
        document.getElementById("msgArea").innerHTML =
            `<p class="ok">登録が完了しました。</p>
             <p>一覧へ戻ります...</p>`;

        setTimeout(() => location.href = "./list.html", 1500);
        return;
    }

    document.getElementById("msgArea").innerHTML =
        "<p class='error'>登録に失敗しました。</p>";
});
</script>

</body>
</html>
