<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç®¡ç†ä¸­ã®å€‰åº«ä¸€è¦§</title>
<link rel="stylesheet" href="./css/style.css">
<script src="https://static.line-scdn.net/liff/2.22.1/sdk.js"></script>
<script src="./js/liff.js"></script>
<script src="./js/api.js"></script>
</head>

<body>
<h2>ç®¡ç†ä¸­ã®é˜²ç½å€‰åº«</h2>

<div id="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
<div id="listArea" style="display:none;"></div>

<a href="./index.html" class="btn-secondary">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>

<script>
async function renderList() {
    const lineId = await getLineId();

    const result = await listWarehouses(lineId);
    if (!result || !result.warehouses) {
        document.getElementById("loading").innerText = "å€‰åº«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
        return;
    }

    const list = result.warehouses;
    const container = document.getElementById("listArea");
    container.innerHTML = "";

    document.getElementById("loading").style.display = "none";
    container.style.display = "block";

    list.forEach(w => {
        const card = document.createElement("div");
        card.className = "card";

        const pub = w.published ? "ğŸ”“ è§£éŒ ä¸­" : "ğŸ”’ æ–½éŒ ä¸­";
        const image = w.imageurl || "./assets/placeholder.png";

        card.innerHTML = `
            <div class="card-header">
                <img src="${image}" class="thumb">
            </div>
            <div class="card-body">
                <h3>${w.number}</h3>
                <p>${w.detail || ""}</p>
                <p>${w.address || ""}</p>
                <p><b>çŠ¶æ…‹ï¼š</b>${pub}</p>

                <button class="btn-primary" onclick="edit('${w.number}')">ç·¨é›†ã™ã‚‹</button>

                <div style="margin-top:10px;">
                    <button class="btn-primary" onclick="unlock('${w.number}')">è§£éŒ ï¼ˆå…¬é–‹ï¼‰</button>
                    <button class="btn-warning" onclick="lock('${w.number}')">æ–½éŒ ï¼ˆéå…¬é–‹ï¼‰</button>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

function edit(number) {
    location.href = `./editWarehouse.html?number=${number}`;
}

async function unlock(number) {
    const lineId = await getLineId();
    await operateWarehouse({ LINEID: lineId, number, mode: "unlock" });
    alert("è§£éŒ ã—ã¾ã—ãŸ");
    location.reload();
}

async function lock(number) {
    const lineId = await getLineId();
    await operateWarehouse({ LINEID: lineId, number, mode: "lock" });
    alert("æ–½éŒ ã—ã¾ã—ãŸ");
    location.reload();
}

renderList();
</script>

</body>
</html>
