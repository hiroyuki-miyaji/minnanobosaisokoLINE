<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者情報登録</title>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="./js/api.js?v=2001"></script>
    <link rel="stylesheet" href="./css/style.css?v=2001">
</head>

<body>

<h2>管理者情報登録</h2>

<div class="form-container">

    <label>氏名</label>
    <input id="name" class="form-input" type="text">

    <label>メールアドレス</label>
    <input id="email" class="form-input" type="email">

    <label>組織名（会社名）</label>
    <input id="org" class="form-input" type="text">

    <button class="btn btn-green" id="btnSubmit">登録する</button>
</div>

<div id="msgArea"></div>

<script>
let lineId = null;

async function init() {

    // --- LIFF 初期化 ---
    await liff.init({ liffId: "2008561144-5WLWMVPP" });

    if (!liff.isLoggedIn()) {
        liff.login();
        return;
    }

    const profile = await liff.getProfile();
    lineId = profile.userId;

    // --- 既存の管理者情報を取得 ---
    const res = await getAdmin(lineId);

    console.log("getAdmin response:", res);

    if (res.result === "success" && Array.isArray(res.items) && res.items.length > 0) {
        const admin = res.items[0];

        // 既存情報をフォームにセット
        document.getElementById("name").value = admin.name ?? "";
        document.getElementById("email").value = admin.email ?? "";
        document.getElementById("org").value = admin.organization ?? "";
    }
}

document.getElementById("btnSubmit").addEventListener("click", async () => {

    const payload = {
        LINEID: lineId,
        name: document.getElementById("name").value,
        email: document.getElementById("email").value,
        organization: document.getElementById("org").value
    };

    const res = await registerAdmin(payload);

    if (res.result === "success") {
        document.getElementById("msgArea").innerHTML =
            "<p class='ok'>登録が完了しました。戻ります...</p>";

        setTimeout(() => location.href = "./index.html", 1200);
        return;
    }

    document.getElementById("msgArea").innerHTML =
        "<p class='error'>登録に失敗しました。</p>";
});

// initialize
init();
</script>
</body>
</html>
