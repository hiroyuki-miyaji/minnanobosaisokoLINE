<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者情報登録</title>

    <!-- ui用のjs -->
    <link rel="stylesheet" href="./css/ui.css?v=1">
    
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- 共通 LIFF ロジック -->
    <script type="module" src="./js/liff.js?v=2001"></script>

    <!-- API -->
    <script src="./js/api.js?v=2001"></script>

    <link rel="stylesheet" href="./css/style.css?v=2001">
</head>

<body>

<h2>管理者情報登録</h2>

<div class="form-container">

    <label>氏名</label>
    <input id="name" class="form-input" type="text">

    <label>メールアドレス</label>
    <input id="email" class="form-input" type="email">

    <label>組織名（会社名）</label>
    <input id="org" class="form-input" type="text">

    <button class="btn btn-green" id="btnSubmit">登録する</button>
</div>

<div id="msgArea"></div>
<div id="debugArea" class="debug"></div>

<script type="module">
import { renderHeader, renderFooter } from "./js/ui.js?v=1";
renderHeader("みんなの防災倉庫管理");
renderFooter();

import { initLiff, getUserProfile, debug } from "./js/liff.js?v=2001";

let lineId = null;

async function main() {
    debug("=== register_admin start ===");

    // --- LIFF 初期化 ---
    const ok = await initLiff();
    if (!ok) return;

    const profile = await getUserProfile();
    lineId = profile.userId;

    debug("LINE Profile OK");

    // --- 管理者情報取得 ---
    const res = await getAdmin(lineId);
    debug("getAdmin:OK");

    if (res.result === "success" &&
        Array.isArray(res.items) &&
        res.items.length > 0) {

        const admin = res.items[0];

        document.getElementById("name").value  = admin.name ?? "";
        document.getElementById("email").value = admin.email ?? "";
        document.getElementById("org").value   = admin.organization ?? "";
    }
}

// ---- 登録処理 ----
document.getElementById("btnSubmit").addEventListener("click", async () => {
    const payload = {
        LINEID: lineId,
        name: document.getElementById("name").value,
        email: document.getElementById("email").value,
        organization: document.getElementById("org").value
    };

    debug("registerAdmin payload proccessing");

    const res = await registerAdmin(payload);
    debug("registerAdmin result:OK");

    if (res.result === "success") {
        document.getElementById("msgArea").innerHTML =
            "<p class='ok'>登録が完了しました。戻ります...</p>";
        setTimeout(() => location.href = "./index.html", 1200);
        return;
    }

    document.getElementById("msgArea").innerHTML =
        "<p class='error'>登録に失敗しました。</p>";
});

main();
</script>

</body>
</html>
